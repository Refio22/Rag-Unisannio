name: Update Solr on PDF Change

on:
  push:
    paths:
      - 'Documenti/**'

jobs:
  update-solr:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          apt-utils \
          ca-certificates \
          gnupg \
          lsb-release \
          curl \
          docker.io

    - name: Start Docker Service
      run: sudo systemctl start docker

    - name: Build and Run Solr Docker Container
      run: |
        docker build -t my-solr ./docker
        docker run -d -p 8983:8983 --name my-solr-container my-solr
      env:
        SOLR_URL: http://localhost:8983/solr/regolamento_1/update/json/docs

    - name: Check Docker Container Status and Logs
      run: |
        # Check if the container is running
        if [[ $(docker ps -q -f name=my-solr-container) ]]; then
          echo "Solr container is running."
        else
          echo "Solr container failed to start."
          exit 1
        fi
        # Output Solr container logs
        docker logs my-solr-container
        echo "Waiting for Solr to be ready..."

    - name: Wait for Solr to be Ready
      run: |
        # Wait until Solr responds to HTTP requests
        until $(curl --output /dev/null --silent --head --fail "$SOLR_URL"); do
          echo "Waiting for Solr to be ready..."
          sleep 5
        done
        echo "Solr is ready."

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install Dependencies
      run: pip install requests PyMuPDF

    - name: Run Solr Update Script
      env:
        SOLR_URL: http://localhost:8983/solr/regolamento_1/update/json/docs
        GITHUB_REPO: Refio22/Rag-Unisannio
        DIRECTORY_PATH: Documenti
      run: python ScriptRAS2.py
